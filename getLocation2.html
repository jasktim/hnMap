<!DOCTYPE html>
<html lang="en">
<head>
    <title>一师校园导航系统</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no">
<!--    <script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=GkSYMk8QAIWVk1ZwHx8KigmGxjhk6uS3"></script>-->
    <script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=1H8Dhi2pGmOMYbN4EcaAGr1rv8f7Gmjz"></script>

<!--    <link rel="stylesheet" type="text/css" href="../css/getLocation.css" />-->
    <script src="../js/jquery-3.3.1.min.js"></script>
<!--    <script src="../npm/sweetalert2@11"></script>-->
    <script src="../js/layer.js"></script>
<!--    <script src="https://www.layuicdn.com/layer-v3.1.0/layer.js"></script>-->
    <style>
        #pos-area{
            /*height:500px;*/
            height:750px;
            width: 100%;
        }
        /*#poi_lat{color:red;}*/
        #poi_lat{color:green;}
        #poi_lng{color:green;}
        #poi_address{color:blue;}
    </style>
<!--    <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.5.1/jquery.min.js"></script>-->
<!--    <script charset="utf-8" src="https://map.qq.com/api/js?v=2.exp&key=GV4BZ-COE3X-AAN45-TW4LF-GVVMF-SYBT4"></script>-->
    <script charset="utf-8" src="https://map.qq.com/api/js?v=2.exp&key=CQPBZ-QRWCU-2RGVJ-44CGR-5WCY6-WVB5Q"></script>
    <script type="text/javascript"
            src="https://3gimg.qq.com/lightmap/components/geolocation/geolocation.min.js"></script>
</head>

<body>
<script type="text/javascript" src="https://cdn.bootcss.com/canvas-nest.js/1.0.1/canvas-nest.min.js"></script>
<canvas id="c_n2" width="1920" height="1103" style="position: fixed; top: 0px; left: 0px; z-index: -1; opacity: 0.5;"></canvas>
<marquee behavior="alternate" direction="left" align="middle"><!--<a style="font-family: 'Times New Roman'">${username}</a>，-->欢迎使用一师校园导航系统！！！</marquee>

<div class="ab">
<!--        左侧-->
<!--    <div class="left">-->
<!--        <button class="left_btn" onclick="openChangePasswordModal()">修改密码</button>-->
<!--        <button class="left_btn" onclick="quit()">退出</button>-->
<!--    </div>-->

<!--     弹窗模态框
    <div id="changePasswordModal" class="modal">
        <div class="modal-content">
            <span onclick="closeChangePasswordModal()" style="float: right; cursor: pointer;">&times;</span>
            <h2>修改密码</h2>
            <input type="password" id="oldPassword" placeholder="旧密码"><br>
            <input type="password" id="newPassword" placeholder="新密码"><br>
            <input type="password" id="confirmNewPassword" placeholder="确认新密码"><br>
            <button onclick="changePassword()">确认修改</button>
        </div>
    </div>-->

<!--        中部-->
    <div class="center" >
        <div>当前位置:<span id="now_poi_address"></span>
<!--            <button type="button" onclick="geolocation.getLocation(showPosition, showErr, options)"-->
<!--                    style="padding:0;margin:0;font-size:16px;height: 22px;width: 120px; float: right">获取当前位置</button>-->
        </div>

        <div>到达位置:<span id="poi_address"></span>
        </div>


        <div id="pos-area"></div>
    </div>
<!--        右侧-->
    <div class="right" id="right" >
        <div>起始:经度 <span id="now_lat"></span>,纬度 <span id="now_lng"></span></div>
        <div>到达:经度 <span id="poi_lat"></span>,纬度 <span id="poi_lng"></span>
            <button type="button" onclick="jiexiDriving()" style="padding: 0;margin: 0;font-size: 16px;float: right;">开始导航</button>
        </div>


    </div>
    </div>

</body>
<script type="text/JavaScript">
    // var appkey ="GV4BZ-COE3X-AAN45-TW4LF-GVVMF-SYBT4";
    var appkey ="CQPBZ-QRWCU-2RGVJ-44CGR-5WCY6-WVB5Q";
    var geolocation = new qq.maps.Geolocation(appkey, "myapp");
    var options = {timeout: 8000};
    var porints = [];
    var map/* = new qq.maps.Map()*/;
    // console.log("porints的类型"+typeof porints);
    $(function(){
        //加载完成后就取当前位置
        geolocation.getLocation(showPosition, showErr, options);
    })

    function showPosition(position) {
        console.log(position);
        $('#now_lat').html(position.lat);
        $('#now_lng').html(position.lng);
        // $('#poi_lat').html(position.lat);
        // $('#poi_lng').html(position.lng);
        //取出位置坐标了，设置地图显示出来
        map = new qq.maps.Map(document.getElementById("pos-area"), {
            // 地图的中心地理坐标。
            center: new qq.maps.LatLng(position.lat,position.lng),
            zoom:18
        });
        //添加标记
        var marker = new qq.maps.Marker({
            position:  new qq.maps.LatLng(position.lat,position.lng),
            map: map
        });
        //解析地址
        jiexiNowAddress(position.lat,position.lng);
        // let now_lat = document.getElementById("now_lat").innerHTML;
        // let now_lng = document.getElementById("now_lng").innerHTML;
        // let poi_lat = document.getElementById("poi_lat").innerHTML;
        // let poi_lng = document.getElementById("poi_lng").innerHTML;
        porints.push({"name":"起点","xy":[position.lng,position.lat]});
            // {"name":"终点","xy":[poi_lng,poi_lat]}
        //绑定地图点击事件
        var count = 1;
        qq.maps.event.addListener(map, "click", function (e) {
            $('#poi_lat').html(e.latLng.getLat().toFixed(20));
            $('#poi_lng').html(e.latLng.getLng().toFixed(20));
            // porints.append({"name":"终点","xy":[poi_lng,poi_lat]});
            //先移除标记，再添加标记
            // marker.setMap(null);
            marker = new qq.maps.Marker({
                position:  new qq.maps.LatLng(e.latLng.getLat(),e.latLng.getLng()),
                map: map
            });
            porints.push({"name":"目的"+count++,"xy":[e.latLng.getLng(),e.latLng.getLat()]});

            jiexiAddress(e.latLng.getLat(),e.latLng.getLng());
        });
    };

    function showErr() {
        alert("定位失败！");
        //TODO::尝试IP定位：

    };

    //解析起点地址
    function jiexiNowAddress(lat,lng){
        var  url3 = encodeURI("https://apis.map.qq.com/ws/geocoder/v1/?location=" + lat + "," + lng + "&key="+appkey+"&output=jsonp&&callback=?");
        // var url3 = encodeURI("https://apis.map.qq.com/ws/geocoder/v1/?location=28.19429178446688766257,112.86895675937557825819&key=CQPBZ-QRWCU-2RGVJ-44CGR-5WCY6-WVB5Q&output=jsonp&callback=?");
        $.getJSON(url3, function (result) {
            if(result.result!=undefined){
                $('#now_poi_address').html(result.result.address);
            }else{
                $('#now_poi_address').html('');
            }

        })
    }

    //解析地址
    function jiexiAddress(lat,lng){
        var  url3 = encodeURI("https://apis.map.qq.com/ws/geocoder/v1/?location=" + lat + "," + lng + "&key="+appkey+"&output=jsonp&&callback=?");
        $.getJSON(url3, function (result) {
            if(result.result!=undefined){
                $('#poi_address').html(result.result.address);
            }else{
                $('#poi_address').html('');
            }

        })
    }

    //解析驾车地址
    // console.log("porints的类型"+typeof porints);
    // let name = porints[porints.length-1].name;
    // console.log(name);
    var markersArray = [],route_lines=[];            // 创建Map实例
    // var center=new qq.maps.LatLng( porints[0]['xy'][1],porints[0]['xy'][0]);
    // var map=new qq.maps.Map(document.getElementById("pos-area"),{center:center,zoom:18});
    function showPoly(pointList) {
        for (var i = 0; i < pointList.length; i++) {
            var start =i;var end= i+1;
            if(!pointList[end])return;
            var driving =new qq.maps.DrivingService({
                complete : function(response){
                    directions_routes = response.detail.routes;
                    //所有可选路线方案
                    for(var i = 0;i < directions_routes.length; i++){
                        var route = directions_routes[i];
                        map.fitBounds(response.detail.bounds); //调整地图窗口显示所有路线
                        var polyline = new qq.maps.Polyline(
                            {
                                path: route.path,
                                strokeColor: '#3893F9',
                                // strokeColor: '#ce1f5f',
                                strokeWeight: 6,
                                map: map,
                                // step:
                            }
                        );
                        console.log(polyline);
                        route_lines.push(polyline);
                    }
                }
            });
            console.log("ok");
            driving.search(pointList[start], pointList[end]); //waypoints表示途经点
        }
    }
    function makemarker(center,name){
        var marker=new qq.maps.Marker({position:center,map:map});// 创建标注
        markersArray.push(marker);
        if(name){
            var label = new qq.maps.Label({ content: name,map: map,
                offset: new qq.maps.Size(10, -50),
                position: center,
            });
        }
    }
    function jiexiDriving(){
        porints[porints.length-1].name = "终点";
        var arrayList = [];
        for (var i in porints) {
            var p = porints[i].xy;
            var p1 =new qq.maps.LatLng(p[1],p[0]);
            console.log(p1);
            arrayList.push(p1);
            makemarker(p1,porints[i].name);
        }
        showPoly(arrayList);//显示轨迹
    }



/*
    function jiexiDriving(){
        let now_lat = document.getElementById("now_lat");
        let now_lng = document.getElementById("now_lng");
        let poi_lat = document.getElementById("poi_lat");
        let poi_lng = document.getElementById("poi_lng");
        var  url3 = encodeURI("https://apis.map.qq.com/ws/direction/v1/driving/?from=" + now_lat + "," + now_lng + "to=" + poi_lat + "," + poi_lng + "&output=json&callback=cb&key="+appkey);
        $.getJSON(url3, function (result) {
            console.log(result)
            if(result.result!=undefined){
                $('#poi_address').html(/!*result.result.address*!/'true');
            }else{
                $('#poi_address').html('');
            }

        })
    }
*/

</script>
<!--<script type="text/javascript">
    var map = new BMap.Map("container");
    map.centerAndZoom("湖南第一师范学院", 24);

    map.enableScrollWheelZoom(true);//开启鼠标滚轮缩放
    map.addControl(new BMap.NavigationControl()); //添加平移缩放控件
    map.addControl(new BMap.ScaleControl());  //添加比例尺控件
    // map.addControl(new BMap.OverviewMapControl({isOpen: true}));  //添加缩略地图控件

    var localSearch = new BMap.LocalSearch(map);
    var keyword = "";


    //获取当前位置
    var geolocation = new BMap.Geolocation();
    geolocation.getCurrentPosition(function(r){
        if(this.getStatus() == BMAP_STATUS_SUCCESS){
            map.centerAndZoom(r.point, 24);
            var mk = new BMap.Marker(r.point);
            map.addOverlay(mk);
            map.panTo(r.point);
            console.log('您的位置:'+r.point.lng+','+r.point.lat);
        }else {
            alert('failed'+this.getStatus());
        }
    }, {enableHighAccuracy: true});


    var color=null;

    var person= {};
    var xingzuo="";
    var shengxiao="";


</script>-->
<script>
    function openChangePasswordModal() {
        $('#changePasswordModal').css('display', 'block');
    }

    function closeChangePasswordModal() {
        $('#changePasswordModal').css('display', 'none');
    }

    function changePassword() {
        var oldPassword = $('#oldPassword').val();
        var newPassword = $('#newPassword').val();
        var confirmNewPassword = $('#confirmNewPassword').val();

        // 检查是否有输入内容
        if (oldPassword === '' || newPassword === '' || confirmNewPassword === '') {
            Swal.fire({
                icon: 'error',
                title: '错误',
                text: '请填写所有字段!'
            });
            return;
        }

        // 检查新密码是否一致
        if (newPassword !== confirmNewPassword) {
            Swal.fire({
                icon: 'error',
                title: '错误',
                text: '新密码不一致，请重新输入!'
            });
            return;
        }

        // 发起 AJAX 请求
        $.ajax({
            url: 'changePassword', // 替换为实际的后端处理密码修改的 URL
            method: 'GET',
            data: {
                oldPassword: oldPassword,
                newPassword: newPassword
            },
            async: true,
            cache:true,
            success: function(data) {
                if(data.bool == true) {
                    Swal.fire({
                        icon: 'success',
                        title: '成功',
                        text: '密码修改成功!'
                    });
                    // 获取当前页面的 URL
                    let currentURL = window.location.href;

                    // 替换路径中的 admin/manage 为 login.jsp
                    let newURL = currentURL.substring(0, currentURL.indexOf("/Demo9") + 6) + "/login.jsp";


                    // 设置延迟跳转到上一级目录的 login.jsp 页面
                    setTimeout(function () {
                        window.location.href = newURL;
                    }, 900);
                    closeChangePasswordModal(); // 关闭弹窗
                }
                if(data.bool == false){
                    Swal.fire({
                        icon: 'error',
                        title: '错误',
                        text: '旧密码错误,请重试!'
                    });
                }
            },
            error: function() {
                Swal.fire({
                    icon: 'error',
                    title: '错误',
                    text: '密码修改失败，请重试!'
                });
            }
        });
    }

    function quit() {
        layer.msg('退出成功！', {icon: 6});
        // 获取当前页面的 URL
        var currentURL = window.location.href;

        // 替换路径中的 admin/manage 为 login.jsp
        var newURL = currentURL.substring(0, currentURL.indexOf("/Demo9") + 6)+"/login.jsp";


        // 设置延迟跳转到上一级目录的 login.jsp 页面
        setTimeout(function() {
            window.location.href = newURL;
        }, 900);

    }

</script>

</html>